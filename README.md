# family_bot.io
import telebot
import google.generativeai as genai
import random
from telebot import types

# –í–ê–®–ò –ö–õ–Æ–ß–ò
TOKEN = ''
GOOGLE_API_KEY = ''


# === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
bot = telebot.TeleBot(TOKEN)

try:
    bot_info = bot.get_me()
    BOT_USERNAME = f"@{bot_info.username}"
    print(f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ –ø–æ–ª—É—á–µ–Ω–∞: ID: {bot_info.id}, –ò–º—è: {bot_info.first_name}, Username: {BOT_USERNAME}")
except Exception as e:
    print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ. –û—à–∏–±–∫–∞: {e}")
    exit()

genai.configure(api_key=GOOGLE_API_KEY)
model = genai.GenerativeModel('gemini-1.5-flash-latest')

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_game_data = {}


# === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ (/) ===
def set_main_menu_commands(bot):
    commands = [
        types.BotCommand("/start", "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"),
        types.BotCommand("/menu", "üìñ –û—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
        types.BotCommand("/help", "‚ÑπÔ∏è –ü–æ–º–æ—â—å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"),
        types.BotCommand("/describe_image", "üñºÔ∏è –û–ø–∏—Å–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è –ò–ò"),
        types.BotCommand("/write_post", "‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π"),
        types.BotCommand("/brainstorm", "üí° –ü—Ä–æ–≤–µ—Å—Ç–∏ –º–æ–∑–≥–æ–≤–æ–π —à—Ç—É—Ä–º"),
        types.BotCommand("/game", "üé≤ –°—ã–≥—Ä–∞—Ç—å –≤ '–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ'"),
        types.BotCommand("/fact", "üí° –£–∑–Ω–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π —Ñ–∞–∫—Ç"),
        types.BotCommand("/summarize", "üìù –ö—Ä–∞—Ç–∫–∏–π –ø–µ—Ä–µ—Å–∫–∞–∑ —Ç–µ–∫—Å—Ç–∞"),
    ]
    bot.set_my_commands(commands)


# === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä ===
def create_main_menu_keyboard():
    keyboard = types.InlineKeyboardMarkup(row_width=2)
    
    btn_describe_image = types.InlineKeyboardButton(text="üñºÔ∏è –û–ø–∏—Å–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É", callback_data="describe_image")
    btn_write_post = types.InlineKeyboardButton(text="‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç", callback_data="write_post")
    btn_brainstorm = types.InlineKeyboardButton(text="üí° –ú–æ–∑–≥–æ–≤–æ–π —à—Ç—É—Ä–º", callback_data="brainstorm_ideas")
    btn_ask_ai = types.InlineKeyboardButton(text="‚ùì –û–±—â–∏–π –≤–æ–ø—Ä–æ—Å –∫ –ò–ò", callback_data="ask_ai")
    btn_summarize = types.InlineKeyboardButton(text="üìù –ü–µ—Ä–µ—Å–∫–∞–∑ —Ç–µ–∫—Å—Ç–∞", callback_data="summarize_text")
    btn_fact = types.InlineKeyboardButton(text="üí° –°–ª—É—á–∞–π–Ω—ã–π —Ñ–∞–∫—Ç", callback_data="get_fact")
    btn_game = types.InlineKeyboardButton(text="üé≤ –ü—Ä–æ—Å—Ç–∞—è –∏–≥—Ä–∞", callback_data="play_game")
    btn_help = types.InlineKeyboardButton(text="‚ÑπÔ∏è –ü–æ–º–æ—â—å", callback_data="help")

    keyboard.add(btn_ask_ai, btn_describe_image, btn_write_post, btn_brainstorm, btn_summarize, btn_fact, btn_game, btn_help)
    return keyboard

# === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ ===

@bot.message_handler(commands=['start', 'menu'])
def show_menu(message):
    user_name = message.from_user.first_name
    menu_text = f"–ü—Ä–∏–≤–µ—Ç, {user_name}! –Ø —Ç–≤–æ–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –í—ã–±–µ—Ä–∏, —á–µ–º –∑–∞–π–º–µ–º—Å—è:"
    keyboard = create_main_menu_keyboard()
    bot.send_message(message.chat.id, menu_text, reply_markup=keyboard)

@bot.message_handler(commands=['help'])
def send_help(message):
    help_text = (
        "ü§ñ *–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:*\n\n"
        "/start, /menu - –û—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.\n"
        "/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.\n\n"
        "--- –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ –∏ –ö–æ–Ω—Ç–µ–Ω—Ç ---\n"
        "/describe_image - –ü–æ–º–æ–≥–∞–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–ø—Ç (–æ–ø–∏—Å–∞–Ω–∏–µ) –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π, —Ä–∏—Å—É—é—â–∏—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏.\n"
        "/write_post - –ü–∏—à–µ—Ç –≥–æ—Ç–æ–≤—ã–π –ø–æ—Å—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π –Ω–∞ –≤–∞—à—É —Ç–µ–º—É.\n"
        "/brainstorm - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ –∏–¥–µ–∏ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.\n\n"
        "--- –£—Ç–∏–ª–∏—Ç—ã –∏ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è ---\n"
        "/summarize - –î–µ–ª–∞–µ—Ç –∫—Ä–∞—Ç–∫–∏–π –ø–µ—Ä–µ—Å–∫–∞–∑ –≤–∞—à–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n"
        "/fact - –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Å–ª—É—á–∞–π–Ω—ã–π —Ñ–∞–∫—Ç.\n"
        "/game - –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å—ã–≥—Ä–∞—Ç—å –≤ '–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ'.\n\n"
        "üí° –î–ª—è –æ–±—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∫ –ò–ò –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ –≤ —á–∞—Ç (–≤ –≥—Ä—É–ø–ø–∞—Ö ‚Äî —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –º–µ–Ω—è)."
    )
    bot.send_message(message.chat.id, help_text, parse_mode='Markdown')

# --- –ö–æ–º–∞–Ω–¥—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ register_next_step_handler ---

@bot.message_handler(commands=['describe_image'])
def ask_for_image_to_describe(message):
    msg = bot.send_message(message.chat.id, "–û—Ç–ª–∏—á–Ω–æ! –û–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –∫–∞–∫—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å, –∞ —è –ø—Ä–µ–≤—Ä–∞—â—É —ç—Ç–æ –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç.")
    bot.register_next_step_handler(msg, process_image_description)

@bot.message_handler(commands=['write_post'])
def ask_for_post_topic(message):
    msg = bot.send_message(message.chat.id, "–ö–∞–∫–æ–≤–∞ —Ç–µ–º–∞ –≤–∞—à–µ–≥–æ –±—É–¥—É—â–µ–≥–æ –ø–æ—Å—Ç–∞? –û–ø–∏—à–∏—Ç–µ –µ–µ, –∏ —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é —Ç–µ–∫—Å—Ç.")
    bot.register_next_step_handler(msg, generate_social_media_post)

@bot.message_handler(commands=['brainstorm'])
def ask_for_brainstorm_topic(message):
    msg = bot.send_message(message.chat.id, "–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ —Ç–µ–º—É –¥–ª—è –º–æ–∑–≥–æ–≤–æ–≥–æ —à—Ç—É—Ä–º–∞, –∏ —è –Ω–∞–∫–∏–Ω—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–¥–µ–π.")
    bot.register_next_step_handler(msg, generate_brainstorm_ideas)

@bot.message_handler(commands=['game'])
def start_game(message):
    user_id = message.from_user.id
    secret_number = random.randint(1, 10)
    user_game_data[user_id] = {'secret_number': secret_number, 'attempts': 3}
    msg = bot.send_message(message.chat.id, "–Ø –∑–∞–≥–∞–¥–∞–ª —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10. –£ —Ç–µ–±—è 3 –ø–æ–ø—ã—Ç–∫–∏. –ö–∞–∫–æ–µ —á–∏—Å–ª–æ?")
    bot.register_next_step_handler(msg, process_game_guess)

@bot.message_handler(commands=['summarize'])
def ask_for_text_to_summarize(message):
    msg = bot.send_message(message.chat.id, "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ç—å—é –¥–ª—è –∫—Ä–∞—Ç–∫–æ–≥–æ –ø–µ—Ä–µ—Å–∫–∞–∑–∞.")
    bot.register_next_step_handler(msg, generate_summary)

# --- –ö–æ–º–∞–Ω–¥—ã, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å—Ä–∞–∑—É ---

@bot.message_handler(commands=['fact'])
def send_random_fact(message):
    prompt = "–†–∞—Å—Å–∫–∞–∂–∏ –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –Ω–∞—É—á–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç, –æ –∫–æ—Ç–æ—Ä–æ–º –º–∞–ª–æ –∫—Ç–æ –∑–Ω–∞–µ—Ç. –ü–æ–¥–∞–π –µ–≥–æ –≤ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–π –º–∞–Ω–µ—Ä–µ."
    bot.send_message(message.chat.id, "–ò—â—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç...")
    try:
        response = model.generate_content(prompt)
        bot.send_message(message.chat.id, response.text)
    except Exception as e:
        print(f"ERROR in /fact: {e}")
        bot.send_message(message.chat.id, "–ù–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ —Ñ–∞–∫—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

# === –ü–û–õ–ù–´–ô –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ inline-–∫–Ω–æ–ø–∫–∏ ===
@bot.callback_query_handler(func=lambda call: True)
def handle_callback_query(call):
    actions = {
        "describe_image": lambda: ask_for_image_to_describe(call.message),
        "write_post": lambda: ask_for_post_topic(call.message),
        "brainstorm_ideas": lambda: ask_for_brainstorm_topic(call.message),
        "ask_ai": lambda: bot.send_message(call.message.chat.id, f"–í —ç—Ç–æ–º —á–∞—Ç–µ —è –±—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã —É–ø–æ–º—è–Ω–µ—Ç–µ –º–µ–Ω—è –ø–æ –∏–º–µ–Ω–∏: {BOT_USERNAME}\n\n–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –≤ —ç—Ç–æ—Ç —á–∞—Ç."),
        "summarize_text": lambda: ask_for_text_to_summarize(call.message),
        "get_fact": lambda: send_random_fact(call.message),
        "play_game": lambda: start_game(call.message),
        "help": lambda: send_help(call.message)
    }
    
    action = actions.get(call.data)
    if action:
        action()

    bot.answer_callback_query(call.id)
    try:
        bot.edit_message_reply_markup(chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=None)
    except telebot.apihelper.ApiTelegramException:
        pass # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É–∂–µ –Ω–µ–ª—å–∑—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å

# === –õ–æ–≥–∏–∫–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π, –≤—ã–∑—ã–≤–∞–µ–º—ã—Ö —á–µ—Ä–µ–∑ register_next_step_handler ===

def process_image_description(message):
    user_idea = message.text
    if user_idea.startswith('/'): return # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    prompt_for_gemini = f"""–ü—Ä–µ–≤—Ä–∞—Ç–∏ –ø—Ä–æ—Å—Ç—É—é –∏–¥–µ—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, –≥–µ–Ω–µ—Ä–∏—Ä—É—é—â–µ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Ç–∏–ø–∞ Stable Diffusion –∏–ª–∏ Midjourney). –ü—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ. –í–∫–ª—é—á–∏ –≤ –Ω–µ–≥–æ —Å—Ç–∏–ª—å, –æ—Å–≤–µ—â–µ–Ω–∏–µ, —Ä–∞–∫—É—Ä—Å –∏ –∂–∏–≤—ã–µ –¥–µ—Ç–∞–ª–∏. –í–ê–ñ–ù–û: –í –æ—Ç–≤–µ—Ç–µ –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≥–æ—Ç–æ–≤—ã–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤. –ò–¥–µ—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_idea}" """
    thinking_msg = bot.send_message(message.chat.id, "–ü—Ä–∏–¥—É–º—ã–≤–∞—é –∏–¥–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ö—É–¥–æ–∂–Ω–∏–∫–∞-–Ω–µ–π—Ä–æ—Å–µ—Ç–∏...")
    
    try:
        response = model.generate_content(prompt_for_gemini)
        image_prompt = response.text.strip()
        service_url = "https://huggingface.co/spaces/stabilityai/stable-diffusion-3-medium"
        keyboard = types.InlineKeyboardMarkup()
        url_button = types.InlineKeyboardButton(text="üé® –°–æ–∑–¥–∞—Ç—å –ø–æ —ç—Ç–æ–º—É –æ–ø–∏—Å–∞–Ω–∏—é", url=service_url)
        keyboard.add(url_button)
        result_text = (f"–í–æ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏:\n\n```\n{image_prompt}\n```\n\n"
                       f"üëÜ **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ** —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç.\nüëá **–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É**, –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ –ø–æ–ª–µ 'Prompt' –∏ —Ç–≤–æ—Ä–∏—Ç–µ –º–∞–≥–∏—é!")
        bot.edit_message_text(result_text, chat_id=thinking_msg.chat.id, message_id=thinking_msg.message_id, 
                              reply_markup=keyboard, parse_mode='Markdown')
    except Exception as e:
        print(f"ERROR in process_image_description: {e}")
        bot.edit_message_text("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –Ω–µ —Å–º–æ–≥ –ø—Ä–∏–¥—É–º–∞—Ç—å –ø—Ä–æ–º–ø—Ç.", 
                              chat_id=thinking_msg.chat.id, message_id=thinking_msg.message_id)

def generate_social_media_post(message):
    topic = message.text
    if topic.startswith('/'): return
    prompt = f"–ù–∞–ø–∏—à–∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Å—Ç –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Instagram) –Ω–∞ —Ç–µ–º—É '{topic}'. –í–∫–ª—é—á–∏ –≤ –Ω–µ–≥–æ: –±—Ä–æ—Å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –∏–∑ 2-3 –∞–±–∑–∞—Ü–µ–≤, –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ —Å–º—ã—Å–ª—É —ç–º–æ–¥–∑–∏, –∏ –∑–∞–∫–æ–Ω—á–∏ –ø–æ—Å—Ç –≤–æ–ø—Ä–æ—Å–æ–º –∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∏–ª–∏ –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é."
    bot.send_message(message.chat.id, f"‚úçÔ∏è –ì–æ—Ç–æ–≤–ª—é –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É '{topic}'...")
    try:
        response = model.generate_content(prompt)
        bot.send_message(message.chat.id, response.text, reply_to_message_id=message.message_id)
    except Exception as e:
        print(f"ERROR in generate_social_media_post: {e}")
        bot.send_message(message.chat.id, "–ù–µ —Å–º–æ–≥ –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—É –∏–Ω–∞—á–µ.")

def generate_brainstorm_ideas(message):
    topic = message.text
    if topic.startswith('/'): return
    prompt = f"–ü—Ä–æ–≤–µ–¥–∏ —Å–µ—Å—Å–∏—é –º–æ–∑–≥–æ–≤–æ–≥–æ —à—Ç—É—Ä–º–∞ –Ω–∞ —Ç–µ–º—É '{topic}'. –ü—Ä–µ–¥–ª–æ–∂–∏ 5-7 –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö, –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã—Ö –∏–¥–µ–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —ç—Ç–æ–π —Ç–µ–º–æ–π. –û—Ñ–æ—Ä–º–∏ –∏—Ö –≤ –≤–∏–¥–µ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –∫—Ä–∞—Ç–∫–∏–º –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º –¥–ª—è –∫–∞–∂–¥–æ–π –∏–¥–µ–∏."
    bot.send_message(message.chat.id, f"üí° –£—Å—Ç—Ä–∞–∏–≤–∞—é –º–æ–∑–≥–æ–≤–æ–π —à—Ç—É—Ä–º –ø–æ —Ç–µ–º–µ '{topic}'...")
    try:
        response = model.generate_content(prompt)
        bot.send_message(message.chat.id, response.text, reply_to_message_id=message.message_id)
    except Exception as e:
        print(f"ERROR in generate_brainstorm_ideas: {e}")
        bot.send_message(message.chat.id, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ–∏, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É.")
        
def generate_summary(message):
    user_text = message.text
    if user_text.startswith('/'): return
    prompt = f"–°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π, –Ω–æ –µ–º–∫–∏–π –ø–µ—Ä–µ—Å–∫–∞–∑ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞: '{user_text}'"
    bot.send_message(message.chat.id, "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ–∫—Å—Ç...")
    try:
        response = model.generate_content(prompt)
        bot.send_message(message.chat.id, f"**–ö—Ä–∞—Ç–∫–∏–π –ø–µ—Ä–µ—Å–∫–∞–∑:**\n\n{response.text}", parse_mode='Markdown')
    except Exception as e:
        print(f"ERROR in generate_summary: {e}")
        bot.send_message(message.chat.id, "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç.")
        
def process_game_guess(message):
    user_id = message.from_user.id
    if user_id not in user_game_data:
        bot.send_message(message.chat.id, "–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É –∫–æ–º–∞–Ω–¥–æ–π /game.")
        return
    if message.text.startswith('/'): return

    try:
        guess = int(message.text)
    except ValueError:
        msg = bot.send_message(message.chat.id, "–≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —á–∏—Å–ª–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.")
        bot.register_next_step_handler(msg, process_game_guess)
        return

    game = user_game_data[user_id]
    game['attempts'] -= 1

    if guess == game['secret_number']:
        bot.send_message(message.chat.id, f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è—é, –≤—ã —É–≥–∞–¥–∞–ª–∏! –≠—Ç–æ –±—ã–ª–æ —á–∏—Å–ª–æ {game['secret_number']}.")
        del user_game_data[user_id]
    elif game['attempts'] > 0:
        hint = "–±–æ–ª—å—à–µ" if guess < game['secret_number'] else "–º–µ–Ω—å—à–µ"
        msg = bot.send_message(message.chat.id, f"–ù–µ–≤–µ—Ä–Ω–æ. –ó–∞–≥–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ {hint}. –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: {game['attempts']}.")
        bot.register_next_step_handler(msg, process_game_guess)
    else:
        bot.send_message(message.chat.id, f"üòî –£–≤—ã, –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –Ø –∑–∞–≥–∞–¥–∞–ª —á–∏—Å–ª–æ {game['secret_number']}.")
        del user_game_data[user_id]

# === –ì–õ–ê–í–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –¢–ï–ö–°–¢–ê (–î–õ–Ø AI) --- –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ü–û–°–õ–ï–î–ù–ò–ú ===
@bot.message_handler(content_types=["text"])
def handle_ai_message(message):
    # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –ª–æ–≤–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—ã–ª –ø–æ–π–º–∞–Ω –∫–æ–º–∞–Ω–¥–∞–º–∏
    is_private_chat = message.chat.type == 'private'
    is_mentioned = BOT_USERNAME in message.text

    # –û—Ç–≤–µ—á–∞–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ª–∏—á–∫–∞ –ò–õ–ò –µ—Å–ª–∏ –±–æ—Ç–∞ —É–ø–æ–º—è–Ω—É–ª–∏ –≤ –≥—Ä—É–ø–ø–µ
    if not (is_private_chat or is_mentioned):
        return

    prompt = message.text.replace(BOT_USERNAME, "").strip() if is_mentioned else message.text
    if not prompt:
        bot.send_message(message.chat.id, "–î–∞, —è –∑–¥–µ—Å—å! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?", reply_to_message_id=message.message_id)
        return
    
    thinking_message = bot.send_message(message.chat.id, "ü§î –î—É–º–∞—é –Ω–∞–¥ –≤–∞—à–∏–º –≤–æ–ø—Ä–æ—Å–æ–º...", reply_to_message_id=message.message_id)
    try:
        response = model.generate_content(prompt)
        bot.edit_message_text(response.text, chat_id=thinking_message.chat.id, message_id=thinking_message.message_id)
    except Exception as e:
        print(f"ERROR in handle_ai_message: {e}")
        bot.edit_message_text("–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò.", chat_id=thinking_message.chat.id, message_id=thinking_message.message_id)


# === –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ===
if __name__ == '__main__':
    print("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –º–µ–Ω—é...")
    set_main_menu_commands(bot)
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.polling(non_stop=True)
